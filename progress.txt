# Progress Log
Run: 047f8650-e1d3-4695-bf25-8390e26b061c
Task: Add easter egg ant command to antfarm CLI
Started: 2026-02-11 05:47 ET

## Codebase Patterns
- CLI entry: `src/cli/cli.ts`, commands matched via `group` variable from `process.argv[2]`
- Dynamic imports used for command modules (e.g., `await import("./ant.js")`)
- Build: `npm run build` runs `tsc -p tsconfig.json` + copies HTML + chmod
- Tests: `node --test dist/<file>.test.js` (node:test + node:assert/strict)
- ESM with NodeNext module resolution, `.js` extensions in imports
- RTS dashboard source assets live in `src/server/rts.html` + `src/server/rts-sprites/`; `npm run build` must copy both into `dist/server/`
- Feature structure world styling should be derived from a centralized helper (status -> visual state -> CSS class), then consumed in `renderWorld()` class selection
- RTS API regression tests can use `startDashboard()` + temp repo fixtures + `fetch` to validate end-to-end server flows without browser automation

---

## 2026-02-11 05:47 - US-001: Add ant easter egg module with ASCII art and quotes
- Created `src/cli/ant.ts` with `printAnt()` function, 10 quotes, ASCII ant art
- Created `src/cli/ant.test.ts` with 4 tests (art output, quote output, 8+ unique quotes, no-throw)
- Wired `ant` command into `src/cli/cli.ts` via dynamic import
- Files changed: `src/cli/ant.ts` (new), `src/cli/ant.test.ts` (new), `src/cli/cli.ts` (modified)
- **Learnings:** CLI uses simple if-chain for command routing, not a framework
---

## 2026-02-11 05:52 - US-002: Wire ant command into CLI and add tests
- Created `tests/ant.test.ts` with 3 CLI integration tests (ASCII art, quote output, hidden from help)
- Tests use child_process.execFileSync to run the actual CLI binary
- All acceptance criteria verified: CLI works, hidden from help, tests pass, build passes
- Files changed: `tests/ant.test.ts` (new)
- **Learnings:** Node 22 runs .ts files directly with type stripping; tests in `tests/` use this approach
---

## 2026-02-12 11:34 - US-001: Replace text-only cancel/delete controls with RTS sprite buttons
- Added RTS source page at `src/server/rts.html` and switched BUILD control buttons to icon-backed sprite buttons while preserving IDs/click wiring
- Added new sprite assets: `src/server/rts-sprites/cancel-button.svg` and `src/server/rts-sprites/delete-button.svg`
- Updated build pipeline to copy `src/server/rts.html` and all `src/server/rts-sprites/*` assets into `dist/server/`
- Added regression test `tests/rts-command-controls.test.ts` to validate sprite references, accessibility labels/titles, and src/dist asset presence
- Files changed: `package.json`, `src/server/rts.html`, `src/server/rts-sprites/cancel-button.svg`, `src/server/rts-sprites/delete-button.svg`, `tests/rts-command-controls.test.ts`, `dist/server/rts.html`, `dist/server/rts-sprites/*`, `progress.txt`
- **Learnings:** RTS UI is distributed from `dist/server/rts.html` but should be maintained from `src/server/rts.html` and copied during build
---

## 2026-02-12 11:38 - US-002: Implement Escape-driven draft cancellation (not only placement cancel)
- Added `cancelActiveFeatureDraft()` to remove selected uncommitted feature drafts, clear selection, persist state, and restore idle Action Console content
- Updated Escape keyboard handling to cancel active feature draft flow and still cancel placement mode via `setPlacement(null)`
- Added regression coverage in `tests/rts-escape-draft-cancel.test.ts` for helper behavior and Escape wiring in both `src/server/rts.html` and built `dist/server/rts.html`
- Files changed: `src/server/rts.html`, `dist/server/rts.html`, `tests/rts-escape-draft-cancel.test.ts`, `progress.txt`
- **Learnings:** Draft-only feature buildings are represented as `state.selected.type === 'building'` with `kind === 'feature'` and `committed === false`, so Escape draft-cancel must target that shape explicitly
---

## 2026-02-12 11:41 - US-003: Render draft and in-progress feature structures at half transparency
- Added centralized run-status -> feature visual-state mapping helpers (`featureStructureVisualState` + `featureStructureClassName`) and used them from `renderWorld()` class selection for feature structures
- Applied `.is-half-transparent` to draft and in-progress feature structures and `.is-failed` to failed structures while keeping done structures fully opaque
- Added regression coverage in `tests/rts-feature-transparency-status.test.ts` validating helper presence, state mapping rules, render wiring, and transparency CSS class in both `src/server/rts.html` and built `dist/server/rts.html`
- Files changed: `src/server/rts.html`, `dist/server/rts.html`, `tests/rts-feature-transparency-status.test.ts`, `progress.txt`
- **Learnings:** Feature visual-state policy is now centralized and should be extended via status-set constants (non-terminal/success/failed) instead of adding ad-hoc class logic in rendering loops
---
## 2026-02-12 11:47 - US-004: Remove subagent assignment editing/auto-assign UI while keeping automatic assignments on launch
- Removed editable assignment rows and auto-assign button from Feature Draft Setup panel in `src/server/rts.html`
- Preserved automatic launch assignment derivation via new `deriveLaunchAssignments(slots, draft, agentPool)` helper with slot default and workflow pool fallbacks
- Kept post-launch read-only assigned-agent visibility through existing `renderAgentStatusList(deriveAssignedAgents(...))` console/status list
- Added regression test `tests/rts-assignment-ui-removal.test.ts` covering UI removal, automatic launch assignment derivation, and post-launch read-only assignment visibility in both `src/server/rts.html` and built `dist/server/rts.html`
- Files changed: `src/server/rts.html`, `tests/rts-assignment-ui-removal.test.ts`, `dist/server/rts.html`, `progress.txt`
- **Learnings:** For RTS dashboard changes, validate both source and built HTML because tests assert parity across `src/server/rts.html` and `dist/server/rts.html`.
---
## 2026-02-12 21:20 - US-001: Add research agenda field to Research Lab state and persistence
- Extended Research Lab normalization in `src/server/rts.html` with `agenda` defaulting to empty string for backward-compatible loads.
- Wired agenda-safe persistence by including normalized `researchBuildings` in `snapshotPersistableState()` and initializing new labs with `agenda: ''`.
- Added regression coverage in `tests/rts-research-agenda-persistence.test.ts` validating agenda defaulting and persistence snapshot wiring in both `src/server/rts.html` and `dist/server/rts.html`.
- Files changed: `src/server/rts.html`, `tests/rts-research-agenda-persistence.test.ts`, `progress.txt`
- **Learnings:** RTS state snapshots can persist selective layout-owned entity arrays (e.g., `researchBuildings`) when paired with server-side layout upsert reconciliation.
---
## 2026-02-12 21:29 - US-001: Fix RTS building palette e2e regression after agenda persistence changes
- Restored `<div class="command-title">BUILD FORGE 4</div>` in `src/server/rts.html` command bar so palette UI matches e2e selector contract.
- Rebuilt dist artifacts via `npm run build` so `dist/server/rts.html` includes the same command title element.
- Confirmed the previously failing required suite now passes.
- Files changed: `src/server/rts.html`, `progress.txt`
- **Learnings:** `tests/rts-building-palette.e2e.test.ts` treats `.command-title` as a required UI contract, so command-bar refactors must preserve that selector/text or update tests in lockstep.
---

## 2026-02-12 21:40 - US-002: Add agenda textarea to Research Console and bind it to selected lab
- Added a labeled `Current Agenda` textarea in `renderResearchLabPanel` above the Research action controls.
- Bound textarea `input` and `change` events to update the selected lab `agenda` immediately and persist via `queuePersist()`.
- Ensured panel re-renders show the existing `lab.agenda` text, preserving the entered agenda when reopening the same lab.
- Added regression test `tests/rts-research-agenda-textarea-binding.test.ts` to assert agenda textarea rendering, agenda value binding, and persistence wiring in both `src/server/rts.html` and `dist/server/rts.html`.
- Files changed: `src/server/rts.html`, `dist/server/rts.html`, `tests/rts-research-agenda-textarea-binding.test.ts`, `progress.txt`
- **Learnings:** Research Console panel changes should include explicit src/dist parity checks because tests validate both authored and built RTS HTML.
---
## 2026-02-12 22:08 - US-001: Normalize feature-run progress and success bar coloring in RTS view
- Updated `runProgress(run)` to clamp active, non-pending/non-queued work to a minimum 5% when no steps are complete yet
- Added `featureRunProgressBarColor(building)` and switched `renderWorld()` feature bar coloring to centralized success/failed/in-flight status mapping
- Expanded build-note rendering to show PR READY for normalized success statuses (`done`/`completed`/`success`) and an ERROR notification for failed/error terminal statuses
- Added regression coverage in `tests/rts-progress-color-status.test.ts` validating progress clamp, color helper wiring, and success/error note mapping in both `src/server/rts.html` and `dist/server/rts.html`
- Files changed: `src/server/rts.html`, `tests/rts-progress-color-status.test.ts`, `dist/server/rts.html`, `progress.txt`
- **Learnings:** For feature-run bars/notes, derive state from `getDisplayRunStatus(...)` + shared status sets instead of direct `run.status` string checks so optimistic overrides and aliases stay consistent.

---
## 2026-02-12 22:06 - US-001: Implement local git repository discovery API for RTS base setup
- Replaced stubbed `/api/local-repos` response with server-side discovery from configured/default local roots
- Added local repo discovery helpers in `src/server/dashboard.ts` to scan directories for `.git` (directory or file), normalize absolute paths, de-duplicate results, derive display name, and attach `suggestedPort` when inferable
- Added regression coverage in `tests/local-repos-discovery.test.ts` for filtering non-repos, normalization/name mapping, dedupe behavior, and `suggestedPort` inference
- Files changed: `src/server/dashboard.ts`, `tests/local-repos-discovery.test.ts`, `progress.txt`
- **Learnings:** RTS path-based port suggestions are currently derived from path naming conventions (`/antfarm` -> 3333, `antfarm-feature-<n>` -> 3400 + n%400); backend helpers should stay in sync with this convention.
---
## 2026-02-12 22:53 - US-002: Wire New Base dropdown to discovered local repositories with deterministic defaults
- Added RTS local repo sync helper and wired it into bootstrap + runtime refresh so base draft rendering uses current `/api/local-repos` data
- Updated base clone form selection flow to map options from `state.localRepos`, preserve/re-apply existing selection, and deterministically auto-fill `targetPath` + `port` from `suggestedPort` with path-based fallback logic
- Preserved existing create validation behavior for existing-repo mode vs clone mode
- Added regression test `tests/rts-base-local-repo-dropdown.test.ts` to verify local repo sync wiring, dropdown option sourcing, deterministic selection defaults, and payload/validation guards in both `src/server/rts.html` and `dist/server/rts.html`
- Files changed: `src/server/rts.html`, `tests/rts-base-local-repo-dropdown.test.ts`, `dist/server/rts.html`, `progress.txt`
- **Learnings:** Base draft form logic should centralize existing-repo selection side effects (target path + port) in one helper so initial render and change events stay consistent.
---
## 2026-02-12 23:20 - US-003: Add end-to-end regression coverage for local repo options in base creation flow
- Added dashboard endpoint support for existing-repo base creation via `POST /api/rts/base/clone` with git repo path validation and explicit existing mode response
- Added `tests/rts-base-existing-repo.e2e.test.ts` to boot `startDashboard`, create a deterministic temporary local git repo fixture, verify `/api/local-repos` discovery, and verify existing-repo base creation succeeds without clone URL payload
- Expanded RTS e2e script to run both palette UI regression and existing-repo base flow regression
- Files changed: `src/server/dashboard.ts`, `tests/rts-base-existing-repo.e2e.test.ts`, `package.json`, `progress.txt`
- **Learnings:** RTS base creation server contract now explicitly supports existing-local-repo mode through `/api/rts/base/clone`; regression coverage should assert this contract directly.
---
