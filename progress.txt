# Progress Log
Run: 047f8650-e1d3-4695-bf25-8390e26b061c
Task: Add easter egg ant command to antfarm CLI
Started: 2026-02-11 05:47 ET

## Codebase Patterns
- Mobile touch interactions should be routed through shared world gesture guards (`shouldIgnoreTouchWorldGesture`) to avoid conflicts with palette cards and panel controls
- CLI entry: `src/cli/cli.ts`, commands matched via `group` variable from `process.argv[2]`
- Dynamic imports used for command modules (e.g., `await import("./ant.js")`)
- Build: `npm run build` runs `tsc -p tsconfig.json` + copies HTML + chmod
- Tests: `node --test dist/<file>.test.js` (node:test + node:assert/strict)
- ESM with NodeNext module resolution, `.js` extensions in imports
- RTS dashboard source assets live in `src/server/rts.html` + `src/server/rts-sprites/`; `npm run build` must copy both into `dist/server/`
- Feature structure world styling should be derived from a centralized helper (status -> visual state -> CSS class), then consumed in `renderWorld()` class selection
- RTS API regression tests can use `startDashboard()` + temp repo fixtures + `fetch` to validate end-to-end server flows without browser automation
- Static dashboard assets should be authored in `src/server/`, copied by `npm run build`, and served in `dashboard.ts` with dist-first + src fallback resolution
- RTS PWA client hooks should use defensive browser capability guards (`'serviceWorker' in navigator`, `beforeinstallprompt`) so desktop browsers keep existing UX unchanged
- Mobile RTS shell mode should be toggled by layout classes (`mobile-tab-build|runs|intel`) with desktop fallback behavior explicitly restored in JS when viewport exits mobile breakpoints
- Action Console mobile refactors should use shared `renderPanelCard(...)` and `openMobileSheet(...)` helpers so collapsible cards, CTA ordering, and long-form editors stay consistent across Feature/Research/Warehouse panels
- RTS mobile performance-sensitive visual writes (camera transform vars) should be funneled through `updateCameraVisuals()` + `scheduleVisualFrame()` (requestAnimationFrame) instead of direct style writes inside pointer/touch loops
- Runtime polling in RTS should use self-scheduled `setTimeout` (`scheduleRuntimePoll`) with bounded retry backoff so offline/reconnect UX and poll recovery stay centralized
- RTS multi-panel API responses should use `createPanelUpdateEnvelope` + `PANEL_TARGETS` (`src/server/panel-update-contract.ts`) so panel targets stay typed and centrally validated.
- RTS client panel swaps should flow through target registries (`panelPatchRenderers`, `buildingSelectionRenderers`) so new panel targets/kinds can be added without changing click handlers.

---

## 2026-02-11 05:47 - US-001: Add ant easter egg module with ASCII art and quotes
- Created `src/cli/ant.ts` with `printAnt()` function, 10 quotes, ASCII ant art
- Created `src/cli/ant.test.ts` with 4 tests (art output, quote output, 8+ unique quotes, no-throw)
- Wired `ant` command into `src/cli/cli.ts` via dynamic import
- Files changed: `src/cli/ant.ts` (new), `src/cli/ant.test.ts` (new), `src/cli/cli.ts` (modified)
- **Learnings:** CLI uses simple if-chain for command routing, not a framework
---

## 2026-02-11 05:52 - US-002: Wire ant command into CLI and add tests
- Created `tests/ant.test.ts` with 3 CLI integration tests (ASCII art, quote output, hidden from help)
- Tests use child_process.execFileSync to run the actual CLI binary
- All acceptance criteria verified: CLI works, hidden from help, tests pass, build passes
- Files changed: `tests/ant.test.ts` (new)
- **Learnings:** Node 22 runs .ts files directly with type stripping; tests in `tests/` use this approach
---

## 2026-02-12 11:34 - US-001: Replace text-only cancel/delete controls with RTS sprite buttons
- Added RTS source page at `src/server/rts.html` and switched BUILD control buttons to icon-backed sprite buttons while preserving IDs/click wiring
- Added new sprite assets: `src/server/rts-sprites/cancel-button.svg` and `src/server/rts-sprites/delete-button.svg`
- Updated build pipeline to copy `src/server/rts.html` and all `src/server/rts-sprites/*` assets into `dist/server/`
- Added regression test `tests/rts-command-controls.test.ts` to validate sprite references, accessibility labels/titles, and src/dist asset presence
- Files changed: `package.json`, `src/server/rts.html`, `src/server/rts-sprites/cancel-button.svg`, `src/server/rts-sprites/delete-button.svg`, `tests/rts-command-controls.test.ts`, `dist/server/rts.html`, `dist/server/rts-sprites/*`, `progress.txt`
- **Learnings:** RTS UI is distributed from `dist/server/rts.html` but should be maintained from `src/server/rts.html` and copied during build
---

## 2026-02-12 11:38 - US-002: Implement Escape-driven draft cancellation (not only placement cancel)
- Added `cancelActiveFeatureDraft()` to remove selected uncommitted feature drafts, clear selection, persist state, and restore idle Action Console content
- Updated Escape keyboard handling to cancel active feature draft flow and still cancel placement mode via `setPlacement(null)`
- Added regression coverage in `tests/rts-escape-draft-cancel.test.ts` for helper behavior and Escape wiring in both `src/server/rts.html` and built `dist/server/rts.html`
- Files changed: `src/server/rts.html`, `dist/server/rts.html`, `tests/rts-escape-draft-cancel.test.ts`, `progress.txt`
- **Learnings:** Draft-only feature buildings are represented as `state.selected.type === 'building'` with `kind === 'feature'` and `committed === false`, so Escape draft-cancel must target that shape explicitly
---

## 2026-02-12 11:41 - US-003: Render draft and in-progress feature structures at half transparency
- Added centralized run-status -> feature visual-state mapping helpers (`featureStructureVisualState` + `featureStructureClassName`) and used them from `renderWorld()` class selection for feature structures
- Applied `.is-half-transparent` to draft and in-progress feature structures and `.is-failed` to failed structures while keeping done structures fully opaque
- Added regression coverage in `tests/rts-feature-transparency-status.test.ts` validating helper presence, state mapping rules, render wiring, and transparency CSS class in both `src/server/rts.html` and built `dist/server/rts.html`
- Files changed: `src/server/rts.html`, `dist/server/rts.html`, `tests/rts-feature-transparency-status.test.ts`, `progress.txt`
- **Learnings:** Feature visual-state policy is now centralized and should be extended via status-set constants (non-terminal/success/failed) instead of adding ad-hoc class logic in rendering loops
---
## 2026-02-12 11:47 - US-004: Remove subagent assignment editing/auto-assign UI while keeping automatic assignments on launch
- Removed editable assignment rows and auto-assign button from Feature Draft Setup panel in `src/server/rts.html`
- Preserved automatic launch assignment derivation via new `deriveLaunchAssignments(slots, draft, agentPool)` helper with slot default and workflow pool fallbacks
- Kept post-launch read-only assigned-agent visibility through existing `renderAgentStatusList(deriveAssignedAgents(...))` console/status list
- Added regression test `tests/rts-assignment-ui-removal.test.ts` covering UI removal, automatic launch assignment derivation, and post-launch read-only assignment visibility in both `src/server/rts.html` and built `dist/server/rts.html`
- Files changed: `src/server/rts.html`, `tests/rts-assignment-ui-removal.test.ts`, `dist/server/rts.html`, `progress.txt`
- **Learnings:** For RTS dashboard changes, validate both source and built HTML because tests assert parity across `src/server/rts.html` and `dist/server/rts.html`.
---
## 2026-02-12 21:20 - US-001: Add research agenda field to Research Lab state and persistence
- Extended Research Lab normalization in `src/server/rts.html` with `agenda` defaulting to empty string for backward-compatible loads.
- Wired agenda-safe persistence by including normalized `researchBuildings` in `snapshotPersistableState()` and initializing new labs with `agenda: ''`.
- Added regression coverage in `tests/rts-research-agenda-persistence.test.ts` validating agenda defaulting and persistence snapshot wiring in both `src/server/rts.html` and `dist/server/rts.html`.
- Files changed: `src/server/rts.html`, `tests/rts-research-agenda-persistence.test.ts`, `progress.txt`
- **Learnings:** RTS state snapshots can persist selective layout-owned entity arrays (e.g., `researchBuildings`) when paired with server-side layout upsert reconciliation.
---
## 2026-02-12 21:29 - US-001: Fix RTS building palette e2e regression after agenda persistence changes
- Restored `<div class="command-title">BUILD FORGE 4</div>` in `src/server/rts.html` command bar so palette UI matches e2e selector contract.
- Rebuilt dist artifacts via `npm run build` so `dist/server/rts.html` includes the same command title element.
- Confirmed the previously failing required suite now passes.
- Files changed: `src/server/rts.html`, `progress.txt`
- **Learnings:** `tests/rts-building-palette.e2e.test.ts` treats `.command-title` as a required UI contract, so command-bar refactors must preserve that selector/text or update tests in lockstep.
---

## 2026-02-12 21:40 - US-002: Add agenda textarea to Research Console and bind it to selected lab
- Added a labeled `Current Agenda` textarea in `renderResearchLabPanel` above the Research action controls.
- Bound textarea `input` and `change` events to update the selected lab `agenda` immediately and persist via `queuePersist()`.
- Ensured panel re-renders show the existing `lab.agenda` text, preserving the entered agenda when reopening the same lab.
- Added regression test `tests/rts-research-agenda-textarea-binding.test.ts` to assert agenda textarea rendering, agenda value binding, and persistence wiring in both `src/server/rts.html` and `dist/server/rts.html`.
- Files changed: `src/server/rts.html`, `dist/server/rts.html`, `tests/rts-research-agenda-textarea-binding.test.ts`, `progress.txt`
- **Learnings:** Research Console panel changes should include explicit src/dist parity checks because tests validate both authored and built RTS HTML.
---
## 2026-02-12 22:06 - US-001: Implement local git repository discovery API for RTS base setup
- Replaced stubbed `/api/local-repos` response with server-side discovery from configured/default local roots
- Added local repo discovery helpers in `src/server/dashboard.ts` to scan directories for `.git` (directory or file), normalize absolute paths, de-duplicate results, derive display name, and attach `suggestedPort` when inferable
- Added regression coverage in `tests/local-repos-discovery.test.ts` for filtering non-repos, normalization/name mapping, dedupe behavior, and `suggestedPort` inference
- Files changed: `src/server/dashboard.ts`, `tests/local-repos-discovery.test.ts`, `progress.txt`
- **Learnings:** RTS path-based port suggestions are currently derived from path naming conventions (`/antfarm` -> 3333, `antfarm-feature-<n>` -> 3400 + n%400); backend helpers should stay in sync with this convention.
---
## 2026-02-12 22:53 - US-002: Wire New Base dropdown to discovered local repositories with deterministic defaults
- Added RTS local repo sync helper and wired it into bootstrap + runtime refresh so base draft rendering uses current `/api/local-repos` data
- Updated base clone form selection flow to map options from `state.localRepos`, preserve/re-apply existing selection, and deterministically auto-fill `targetPath` + `port` from `suggestedPort` with path-based fallback logic
- Preserved existing create validation behavior for existing-repo mode vs clone mode
- Added regression test `tests/rts-base-local-repo-dropdown.test.ts` to verify local repo sync wiring, dropdown option sourcing, deterministic selection defaults, and payload/validation guards in both `src/server/rts.html` and `dist/server/rts.html`
- Files changed: `src/server/rts.html`, `tests/rts-base-local-repo-dropdown.test.ts`, `dist/server/rts.html`, `progress.txt`
- **Learnings:** Base draft form logic should centralize existing-repo selection side effects (target path + port) in one helper so initial render and change events stay consistent.
---
## 2026-02-12 23:20 - US-003: Add end-to-end regression coverage for local repo options in base creation flow
- Added dashboard endpoint support for existing-repo base creation via `POST /api/rts/base/clone` with git repo path validation and explicit existing mode response
- Added `tests/rts-base-existing-repo.e2e.test.ts` to boot `startDashboard`, create a deterministic temporary local git repo fixture, verify `/api/local-repos` discovery, and verify existing-repo base creation succeeds without clone URL payload
- Expanded RTS e2e script to run both palette UI regression and existing-repo base flow regression
- Files changed: `src/server/dashboard.ts`, `tests/rts-base-existing-repo.e2e.test.ts`, `package.json`, `progress.txt`
- **Learnings:** RTS base creation server contract now explicitly supports existing-local-repo mode through `/api/rts/base/clone`; regression coverage should assert this contract directly.
---
## 2026-02-13 15:24 - US-001: Add PWA asset pipeline and mobile metadata serving
- Added PWA server assets in `src/server/`: `manifest.webmanifest`, `service-worker.v1.js`, `icon-192.png`, and `icon-512.png`
- Extended build pipeline in `package.json` to copy new PWA assets into `dist/server/` alongside existing RTS assets
- Updated `src/server/dashboard.ts` static serving to expose `/manifest.webmanifest`, `/service-worker.v1.js`, `/icon-192.png`, and `/icon-512.png` with explicit MIME types and cache headers
- Added `tests/pwa-assets-serving.e2e.test.ts` to verify manifest metadata shape, dist copy output, and HTTP 200 + correct content types for manifest/service worker/icon endpoints
- Files changed: `package.json`, `src/server/dashboard.ts`, `src/server/manifest.webmanifest`, `src/server/service-worker.v1.js`, `src/server/icon-192.png`, `src/server/icon-512.png`, `tests/pwa-assets-serving.e2e.test.ts`, `progress.txt`
- **Learnings:** PWA installability support for RTS can be validated with lightweight server e2e checks (no browser automation) by asserting manifest/service-worker headers from `startDashboard()`.
---
## 2026-02-13 15:40 - US-002: Register service worker and install metadata in RTS client
- Added installable mobile metadata in `src/server/rts.html`: manifest link, theme-color, and Apple mobile web-app meta tags.
- Added client PWA bootstrap in `src/server/rts.html` with guarded service worker registration (`'serviceWorker' in navigator`), update checks on updatefound/visibility/focus, and error-safe registration handling.
- Added minimal in-app install CTA state (`#installAppBtn`) that is only shown when `beforeinstallprompt` is emitted and hidden again after prompt/app install.
- Added regression test `tests/rts-pwa-client-bootstrap.test.ts` to assert metadata tags, service worker guard/registration wiring, and conditional install prompt state in both `src/server/rts.html` and `dist/server/rts.html`.
- Updated `test:e2e:rts` to include the new RTS PWA bootstrap regression.
- Files changed: `src/server/rts.html`, `tests/rts-pwa-client-bootstrap.test.ts`, `package.json`, `progress.txt`.
- **Learnings:** Keep PWA enhancement hooks behind capability detection so mobile install flows can be added without changing desktop behavior.
---
## 2026-02-13 16:07 - US-003: Implement mobile-first layout shell with game UI patterns
- Added a mobile shell in `src/server/rts.html` with a top status strip (`#mobileStatusStrip`) and thumb-friendly bottom tab dock (`#mobileActionTabs`) containing Build/Runs/Intel tabs.
- Implemented responsive tab behavior with `initMobileLayoutShell`, `setMobileTab`, and `applyMobilePanelVisibility` so mobile viewports switch visible panel content while desktop keeps the existing right-dock action panel behavior.
- Added live mobile HUD status updates (`updateMobileStatusStrip`) to surface run count, current selection type, and running agent count.
- Added regression coverage in `tests/rts-mobile-layout-shell.test.ts` validating status strip/dock presence, tab panel switching wiring, and desktop fallback behavior in both `src/server/rts.html` and `dist/server/rts.html`.
- Extended `test:e2e:rts` script to include the new responsive shell regression test.
- Files changed: `src/server/rts.html`, `tests/rts-mobile-layout-shell.test.ts`, `package.json`, `progress.txt`
- **Learnings:** Mobile RTS HUD ergonomics can be delivered safely by breakpoint-scoped layout classes while preserving desktop contracts through explicit non-mobile reset logic.
---


## 2026-02-13 16:45 - US-004: Add touch-native camera and placement interactions
- Added touch-native world interaction handling in `src/server/rts.html` with single-finger mobile panning, guarded gesture starts, and touch placement commit flow for all building kinds.
- Added optional pinch zoom state plumbing with bounded min/max and explicit default disabled lock (`cameraZoom.enabled = false`) so mobile can safely defer zoom without unstable behavior.
- Added hover suppression + conflict guards (`shouldIgnoreTouchWorldGesture`) so touch interactions don't depend on hover-only UI and don't interfere with palette card drag/drop controls.
- Added regression test `tests/rts-touch-native-interactions.test.ts` to validate touch pan wiring, touch placement/select compatibility, and bounded pinch zoom fallback in both `src/server/rts.html` and `dist/server/rts.html`.
- Updated `test:e2e:rts` script to include the new touch interaction regression test.
- Files changed: `src/server/rts.html`, `tests/rts-touch-native-interactions.test.ts`, `package.json`, `progress.txt`
- **Learnings:** Keep touch gesture routing centralized at `worldWrapEl` + window-level touch listeners and gate starts with control-target guards to preserve existing click/select/drag contracts.
---
## 2026-02-13 16:58 - US-001: Define an internal panel-update contract with explicit target regions
- Added shared panel update contract in `src/server/panel-update-contract.ts` with typed envelope/patch models, canonical panel target IDs, and deterministic target validation/normalization helpers.
- Wired RTS API update paths in `src/server/dashboard.ts` to emit `uiUpdate` envelopes for feature run start and delete flows, targeting bottom command bar, right action sidebar, and left media panel placeholder.
- Added regression coverage in `tests/panel-update-contract.test.ts` for target constants, deterministic rejection of unknown targets, normalization behavior, and dashboard usage of the contract.
- Files changed: `src/server/panel-update-contract.ts`, `src/server/dashboard.ts`, `tests/panel-update-contract.test.ts`, `progress.txt`
- **Learnings:** For cross-panel RTS updates, return a typed `uiUpdate` envelope from API responses instead of coupling callers to DOM IDs directly.
---
## 2026-02-13 18:44 - US-005: Refactor action panels into mobile game cards and sheets
- Refactored Feature, Research, and Warehouse Action Console layouts into collapsible card groups using new `renderPanelCard(...)` helper with explicit primary CTA ordering in Feature actions.
- Added mobile bottom-sheet infrastructure (`mobile-sheet`) and wired long-detail flows to it: feature prompt editor now opens in sheet, and research plan detail view opens in sheet from plan rows.
- Updated modal behavior for Library/Power styles on small screens to use bottom-anchored, viewport-constrained sheet-like containers.
- Added keyboard-safe mobile form handling via `wireKeyboardSafeFormControls(...)` with focused-control `scrollIntoView` + `visualViewport` resize/scroll inset handling so active inputs remain recoverable when keyboard is open.
- Added regression coverage in `tests/rts-mobile-panel-cards-sheets.test.ts` validating card groups, sheet wiring, and keyboard-safe form hooks in both `src/server/rts.html` and `dist/server/rts.html`.
- Files changed: `src/server/rts.html`, `tests/rts-mobile-panel-cards-sheets.test.ts`, `dist/server/rts.html`, `progress.txt`
- **Learnings:** For mobile RTS panel ergonomics, centralize card/sheet primitives in shared render helpers and assert src/dist parity so built dashboard HTML remains aligned with source behavior.
---
## 2026-02-13 19:03 - US-002: Add a central panel patch router in the RTS client
- Added a client-side panel patch router in `src/server/rts.html` with target registration (`registerPanelPatchRenderer`) and dispatch (`applyPanelUpdateRouter` / `applyPanelPatch`) keyed by panel target ID.
- Routed default Action Console rendering through the new dispatcher (`routeDefaultActionConsole`) so default sidebar behavior is preserved through the central routing path.
- Refactored building selection panel rendering to a mapped registry (`buildingSelectionRenderers`) so adding new building/panel kinds no longer requires hardcoded click-handler branching.
- Wired feature run start/delete API responses to apply server-provided `uiUpdate` panel patches via the dispatcher.
- Added regression coverage in `tests/rts-panel-patch-router.test.ts` for router presence, default-route behavior, and renderer mapping in both `src/server/rts.html` and `dist/server/rts.html`.
- Files changed: `src/server/rts.html`, `tests/rts-panel-patch-router.test.ts`, `dist/server/rts.html`, `progress.txt`
- **Learnings:** The RTS client now has a target-ID panel dispatch seam that can be extended for future left-panel/video content without changing selection click wiring.
---
## 2026-02-13 20:10 - US-006: Optimize render path for smooth mobile performance
- Refactored high-frequency camera visual updates in `src/server/rts.html` to use requestAnimationFrame coalescing via `scheduleVisualFrame()`/`flushVisualFrame()` so pointer/touch pan loops no longer perform direct per-event style writes.
- Added mobile performance guard CSS under `@media (max-width:760px)` to disable costly shadow/filter effects on world entities, HUD elements, and mobile tab active states.
- Reworked sprite preload flow to prioritize visible assets first (`collectVisibleSpriteUrls()`), defer non-critical assets to idle time, and prevent duplicate fetch/decode work with URL-level promise dedupe (`spritePreloadByUrl` + `preloadSpriteOnce`).
- Added regression coverage in `tests/rts-mobile-performance-guards.test.ts` (src/dist parity) and wired it into `npm run test:e2e:rts`.
- Files changed: `src/server/rts.html`, `tests/rts-mobile-performance-guards.test.ts`, `package.json`, `dist/server/rts.html`, `progress.txt`
- **Learnings:** For RTS mobile smoothness, keep high-frequency DOM writes batched in a frame scheduler and treat sprite preloading as a two-phase path (critical visible assets first, bulk assets in idle time).
---
## 2026-02-13 21:44 - US-007: Provide offline fallback and reconnect UX for field usage
- Added connectivity-aware RTS client UX in `src/server/rts.html`: explicit offline/reconnecting banner, mobile NET status chip, online/offline event listeners, and non-blocking status messaging.
- Replaced fixed runtime polling interval with `scheduleRuntimePoll` + `runRuntimePoll` loop using bounded exponential backoff and clean resume on reconnect.
- Upgraded `src/server/service-worker.v1.js` fetch strategy for app-shell reliability: navigation network-first with `/rts` cache fallback, runtime caching for static sprites/assets, and explicit offline fallback response.
- Added regression suite `tests/rts-offline-reconnect-handling.test.ts` (src/dist parity + service worker behavior) and wired it into `npm run test:e2e:rts`.
- Files changed: `src/server/rts.html`, `src/server/service-worker.v1.js`, `tests/rts-offline-reconnect-handling.test.ts`, `package.json`, `dist/server/rts.html`, `dist/server/service-worker.v1.js`, `progress.txt`.
- **Learnings:** RTS runtime refresh now follows a self-scheduling timeout loop (not `setInterval`) so reconnect/backoff policy can be centralized with connectivity state UX.
---
